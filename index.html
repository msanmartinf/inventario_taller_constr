<!DOCTYPE html>
<html lang="gl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario CM — Taller de Construción</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#6b7280; --soft:#1f2937;
      --txt:#e5e7eb; --accent:#06b6d4; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
      --line:#334155;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
         background:var(--bg);color:var(--txt);}
    header{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .tag{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
    main{display:grid;grid-template-columns:320px 1fr;gap:14px;padding:14px}
    @media (max-width:1000px){
      main{grid-template-columns:1fr}
    }
    aside,section{background:var(--panel);border:1px solid var(--line);border-radius:10px}
    aside{padding:12px}
    section{padding:0;overflow:hidden}
    .block{padding:12px;border-bottom:1px solid var(--line)}
    .block:last-child{border-bottom:none}
    input,select,button,textarea{
      background:var(--soft);border:1px solid var(--line);color:var(--txt);
      border-radius:8px;padding:8px 10px;font-size:14px;outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--accent)}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .btn{cursor:pointer;border:1px solid var(--line)}
    .btn.primary{background:var(--accent);border-color:transparent;color:#002b36;font-weight:700}
    .btn.warn{background:var(--warn);border-color:transparent;color:#111}
    .btn.ok{background:var(--ok);border-color:transparent;color:#063}
    .btn.danger{background:var(--danger);border-color:transparent}
    .muted{color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{text-align:left;font-size:12px;color:var(--muted)}
    tr.low td{background:rgba(245,158,11,0.08)}
    tr.verylow td{background:rgba(239,68,68,0.10)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.low{background:rgba(245,158,11,0.25);color:#fff}
    .pill.verylow{background:rgba(239,68,68,0.35);color:#fff}
    .pill.ok{background:rgba(34,197,94,0.25);color:#fff}
    footer{padding:8px 14px;color:var(--muted);border-top:1px solid var(--line);font-size:12px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .admin-bar{display:flex;gap:8px;align-items:center}
    .hidden{display:none !important}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <h1>Inventario — CM Construción</h1>
    <span class="tag">MVP sen servidor</span>
    <span class="tag">Aviso por <code>mailto:</code></span>
    <span id="roleTag" class="tag">Modo: Operario/a</span>
    <span id="syncTag" class="tag">Datos: Local</span>
  </header>
<main>
    <aside>
      <div class="block">
        <div class="admin-bar">
          <button id="btnOperario" class="btn">Modo Operario/a</button>
          <button id="btnAdmin" class="btn">Modo Admin</button>
          <input id="pinAdmin" type="password" placeholder="PIN admin" class="hidden" />
          <button id="btnPinOk" class="btn ok hidden">Entrar</button>
        </div>
        <div class="hint">Operario/a: rexistrar Entradas/Saídas. • Admin: engadir/editar materiais, mínimos, importar/exportar.</div>
      </div>

      <div class="block">
        <label for="txtBuscar">Buscar material</label>
        <input id="txtBuscar" type="text" placeholder="Código, descrición..." />
        <div class="hint">Filtra en tempo real.</div>
      </div>

      <div id="blkMovimiento" class="block">
        <div class="row">
          <div>
            <label for="selMaterial">Material</label>
            <select id="selMaterial"></select>
          </div>
          <div>
            <label for="numCant">Cantidade</label>
            <input id="numCant" type="number" min="1" step="1" value="1" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="selTipo">Tipo</label>
            <select id="selTipo">
              <option value="IN">Entrada</option>
              <option value="OUT">Saída</option>
              <option value="ADJUST">Axuste (+/-)</option>
            </select>
          </div>
          <div>
            <label for="txtQuen">Usuario (opcional)</label>
            <input id="txtQuen" type="text" placeholder="Nome / Grupo" />
          </div>
        </div>
        <label for="txtMotivo">Motivo/UD (opcional)</label>
        <input id="txtMotivo" type="text" placeholder="Ex: Práctica UD3" />
        <div class="row" style="margin-top:10px">
          <button id="btnRexistrar" class="btn primary">Rexistrar movemento</button>
          <button id="btnProbarAviso" class="btn warn">Probar aviso por correo</button>
        </div>
        <div id="msgMov" class="hint"></div>
      </div>
<div id="blkAdmin" class="block hidden">
        <h3 style="margin:0 0 8px 0;">Materiais (admin)</h3>
        <label for="txtCod">Código</label>
        <input id="txtCod" type="text" placeholder="Ex: CASCO01" />

        <label for="txtDesc">Descrición</label>
        <input id="txtDesc" type="text" placeholder="Ex: Casco de obra" />

        <div class="row">
          <div>
            <label for="txtUnd">Unidade</label>
            <input id="txtUnd" type="text" placeholder="uds / m / caixa..." />
          </div>
          <div>
            <label for="numMin">Stock mínimo</label>
            <input id="numMin" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <label for="txtUbic">Ubicación (opcional)</label>
        <input id="txtUbic" type="text" placeholder="Armario A / Estante 2..." />

        <label for="txtNota">Observacións (opcional)</label>
        <input id="txtNota" type="text" placeholder="Marca, modelo, etc." />

        <div class="row" style="margin-top:10px">
          <button id="btnEngadir" class="btn ok">Engadir / Actualizar</button>
          <button id="btnLimpar" class="btn">Limpar</button>
        </div>

        <div class="hint">
          Se o código xa existe, actualízanse descrición / unidade / mínimo / ubicación / observacións.
        </div>
      </div>

      <div id="blkSync" class="block hidden">
        <h3 style="margin:0 0 8px 0;">Sincronización (admin)</h3>

        <div class="toolbar">
          <button id="btnExport" class="btn">Exportar datos (JSON)</button>
          <label for="fileImport" class="btn">Importar JSON</label>
          <input id="fileImport" type="file" accept="application/json" style="display:none" />
        </div>

        <div class="hint">
          GitHub Pages non permite modificar <code>datos.json</code> desde o navegador.  
          <b>Trabállase en local</b>: cando queiras actualizar datos para todos/as →  
          **Exportar → subir como datos.json → Commit**.
        </div>
      </div>
    </aside>
<section>
      <div class="block">
        <div class="toolbar">
          <span class="muted">Inventario</span>
          <span id="countTag" class="tag">0 materiais</span>
        </div>
      </div>

      <div class="block">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:110px">Código</th>
              <th>Descrición</th>
              <th class="nowrap">Stock</th>
              <th>Mínimo</th>
              <th>Unid.</th>
              <th>Ubicación</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <span>Última actualización: <span id="lblLast"></span></span>
      </footer>
    </section>
  </main>

  <script>
    /* ========= CONFIGURACIÓN BÁSICA ========= */

    // TODO: cambia a lista de destinatarios dos avisos (separados por comas)
    const ALERT_RECIPIENTS = "almacen@centro.gal, coordinacion@centro.gal";

    // TODO: cambia o PIN de administrador
    const ADMIN_PIN = "1234";

    // Nome da clave en LocalStorage
    const LS_KEY = "inventario_cm_constr_v1";

    // Ficheiro JSON inicial (do repo en GitHub)
    const DATOS_URL = "datos.json";

    /* ========= ESTADO ========= */

    let state = {
      materials: [],  // {code, description, unit, stock, min_stock, location, notes}
      movements: [],  // {material_code, type, qty, who, reason, datetime}
      lastSync: null
    };

    /* ========= UTILIDADES ========= */

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const nowISO = () => new Date().toISOString();

    function saveLocal(){
      state.lastSync = nowISO();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      $("#syncTag").textContent = "Datos: Local";
      $("#lblLast").textContent = new Date(state.lastSync).toLocaleString();
      render();
    }
/* ========= CARGA LOCAL ========= */

    function loadLocal(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          state = JSON.parse(raw);
        } catch(e){
          console.warn("LocalStorage corrupto, reiniciando");
          localStorage.removeItem(LS_KEY);
        }
      }
    }

    /* ========= CARGA DATOS INICIAIS DO REPO ========= */

    async function loadInitial(){
      loadLocal();

      // Se xa había datos locais, cargamos eses
      if(state.materials && state.materials.length){
        render();
        return;
      }

      // Se non hai datos locais, cargamos datos.json do repo
      try{
        const res = await fetch(DATOS_URL, {cache:"no-store"});
        if(res.ok){
          const json = await res.json();
          state.materials = json.materials || [];
          state.movements = json.movements || [];
          state.lastSync = nowISO();
          saveLocal();
          $("#syncTag").textContent = "Datos: Importados (datos.json)";
        }
      }catch(e){
        console.warn("Erro cargando datos.json", e);
      }
      render();
    }

    /* ========= RENDER ========= */

    function statusPill(m){
      if(m.stock <= m.min_stock && m.stock > 0) return '<span class="pill low">Baixo</span>';
      if(m.stock <= 0) return '<span class="pill verylow">Esgotado</span>';
      return '<span class="pill ok">Ok</span>';
    }

    function render(){
      const q = $("#txtBuscar").value.trim().toLowerCase();
      const tbody = $("#tbody");
      tbody.innerHTML = "";

      const list = state.materials
        .slice()
        .sort((a,b)=>a.code.localeCompare(b.code))
        .filter(m =>
          (m.code||"").toLowerCase().includes(q) ||
          (m.description||"").toLowerCase().includes(q)
        );

      $("#countTag").textContent = `${list.length} materiais`;

      const frag = document.createDocumentFragment();
      list.forEach(m=>{
        const tr = document.createElement("tr");
        if(m.stock <= 0) tr.classList.add("verylow");
        else if(m.stock <= m.min_stock) tr.classList.add("low");

        tr.innerHTML = `
          <td class="nowrap"><code>${m.code||""}</code></td>
          <td>${m.description||""}</td>
          <td class="nowrap"><strong>${m.stock ?? 0}</strong></td>
          <td class="nowrap">${m.min_stock ?? 0}</td>
          <td>${m.unit||""}</td>
          <td>${m.location||""}</td>
          <td>${statusPill(m)}</td>
        `;
        frag.appendChild(tr);
      });

      tbody.appendChild(frag);

      // Rellenar selector de movemento
      const sel = $("#selMaterial");
      const before = sel.value;
      sel.innerHTML = "";
      state.materials
        .slice()
        .sort((a,b)=>a.code.localeCompare(b.code))
        .forEach(m=>{
          const opt = document.createElement("option");
          opt.value = m.code;
          opt.textContent = `${m.code} — ${m.description}`;
          sel.appendChild(opt);
        });
      if(before) sel.value = before;
    }

    /* ========= OPERACIÓNS DE ADMIN ========= */

    function ensureMaterial(code){
      return state.materials.find(m => (m.code||"").toLowerCase() === (code||"").toLowerCase());
    }

    function addOrUpdateMaterial({code, description, unit, min_stock, location, notes}){
      if(!code) return {ok:false, msg:"Código obrigatorio"};

      const m = ensureMaterial(code);
      if(m){
        // Actualizar
        m.description = description || m.description;
        m.unit = unit || m.unit;
        m.min_stock = Number.isFinite(+min_stock) ? +min_stock : m.min_stock;
        m.location = location || m.location;
        m.notes = notes || m.notes;
      } else {
        // Engadir novo
        state.materials.push({
          code,
          description: description||"",
          unit: unit||"",
          stock: 0,
          min_stock: Number.isFinite(+min_stock) ? +min_stock : 0,
          location: location||"",
          notes: notes||""
        });
      }

      saveLocal();
      return {ok:true};
    }

    /* ========= MOVEMENTOS ========= */

    function applyMovement({code, type, qty, who, reason}){
      const m = ensureMaterial(code);
      if(!m) return {ok:false, msg:"Material non atopado"};

      const nqty = Number.parseInt(qty, 10);
      if(!Number.isFinite(nqty) || nqty <= 0)
        return {ok:false, msg:"Cantidade inválida"};

      let delta = 0;
      if(type === "IN") delta = nqty;
      else if(type === "OUT") delta = -nqty;
      else if(type === "ADJUST") delta = nqty;
      else return {ok:false, msg:"Tipo inválido"};

      const newStock = (m.stock||0) + delta;
      if(newStock < 0) return {ok:false, msg:"Stock insuficiente"};

      m.stock = newStock;

      state.movements.push({
        material_code: code,
        type,
        qty:nqty,
        who:(who||"").trim(),
        reason:(reason||"").trim(),
        datetime: nowISO()
      });

      saveLocal();

      // Se stock <= mínimo → mailto
      if(m.stock <= m.min_stock){
        triggerMailtoLowStock(m, {type, qty:nqty, who, reason});
      }

      return {ok:true};
    }

    /* ========= MAILTO AVISO ========= */

    function triggerMailtoLowStock(material, lastMove){
      const to = encodeURIComponent(ALERT_RECIPIENTS);
      const subject = encodeURIComponent(
        `⚠ Stock baixo: ${material.description||material.code} (stock ${material.stock}/${material.min_stock})`
      );

      const lines = [
        `Material: ${material.code} — ${material.description}`,
        `Stock actual: ${material.stock}`,
        `Mínimo: ${material.min_stock}`,
        `Última operación: ${lastMove.type} de ${lastMove.qty}`,
        lastMove.who ? `Usuario: ${lastMove.who}` : null,
        lastMove.reason ? `Motivo/UD: ${lastMove.reason}` : null,
        `Data/Hora: ${new Date().toLocaleString()}`,
        ``,
        `Ligazón ao inventario: ${location.href}`
      ].filter(Boolean);

      const body = encodeURIComponent(lines.join("\n"));
      window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
    }

    /* ========= EXPORTAR / IMPORTAR ========= */

    function exportJSON(){
      const blob = new Blob([JSON.stringify({
        materials: state.materials,
        movements: state.movements
      }, null, 2)], {type:"application/json"});
      
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "datos_actualizados.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJSON(file){
      const rdr = new FileReader();
      rdr.onload = () => {
        try{
          const obj = JSON.parse(rdr.result);
          if(!Array.isArray(obj.materials) || !Array.isArray(obj.movements)){
            alert("O JSON non ten o formato esperado.");
            return;
          }
          state.materials = obj.materials;
          state.movements = obj.movements;
          saveLocal();
          alert("Datos importados en local.");
        }catch(e){
          alert("Erro lendo JSON: " + e.message);
        }
      };
      rdr.readAsText(file);
    }

    /* ========= EVENTOS ========= */

    $("#txtBuscar").addEventListener("input", render);

    $("#btnOperario").addEventListener("click", ()=>{
      $("#roleTag").textContent = "Modo: Operario/a";
      $("#blkAdmin").classList.add("hidden");
      $("#blkSync").classList.add("hidden");
      $("#pinAdmin").classList.add("hidden");
      $("#btnPinOk").classList.add("hidden");
    });

    $("#btnAdmin").addEventListener("click", ()=>{
      $("#pinAdmin").classList.remove("hidden");
      $("#btnPinOk").classList.remove("hidden");
      $("#pinAdmin").focus();
    });

    $("#btnPinOk").addEventListener("click", ()=>{
      if($("#pinAdmin").value.trim() === ADMIN_PIN){
        $("#roleTag").textContent = "Modo: Admin";
        $("#blkAdmin").classList.remove("hidden");
        $("#blkSync").classList.remove("hidden");
        $("#pinAdmin").classList.add("hidden");
        $("#btnPinOk").classList.add("hidden");
      }else{
        alert("PIN incorrecto");
      }
    });

    $("#btnEngadir").addEventListener("click", ()=>{
      const code = $("#txtCod").value.trim();
      const description = $("#txtDesc").value.trim();
      const unit = $("#txtUnd").value.trim();
      const min_stock = +$("#numMin").value;
      const location = $("#txtUbic").value.trim();
      const notes = $("#txtNota").value.trim();

      const r = addOrUpdateMaterial({code, description, unit, min_stock, location, notes});
      if(r.ok){
        $("#msgMov").textContent = `Material gardado: ${code}`;
        $("#msgMov").style.color = "#22c55e";
        render();
      }else{
        $("#msgMov").textContent = r.msg;
        $("#msgMov").style.color = "#ef4444";
      }
    });

    $("#btnLimpar").addEventListener("click", ()=>{
      ["#txtCod","#txtDesc","#txtUnd","#numMin","#txtUbic","#txtNota"]
        .forEach(sel=>$(sel).value="");
    });

    $("#btnRexistrar").addEventListener("click", ()=>{
      const code = $("#selMaterial").value;
      const type = $("#selTipo").value;

      let qty = +$("#numCant").value;
      if(type!=="ADJUST") qty = Math.abs(qty);

      const who = $("#txtQuen").value;
      const reason = $("#txtMotivo").value;

      const r = applyMovement({code, type, qty, who, reason});
      if(r.ok){
        $("#msgMov").textContent = "Movemento rexistrado.";
        $("#msgMov").style.color = "#22c55e";
        $("#numCant").value = 1;
        $("#txtMotivo").value = "";
        render();
      }else{
        $("#msgMov").textContent = r.msg;
        $("#msgMov").style.color = "#ef4444";
      }
    });

    $("#btnProbarAviso").addEventListener("click", ()=>{
      const code = $("#selMaterial").value;
      const m = ensureMaterial(code);
      if(!m){
        alert("Selecciona un material para probar.");
        return;
      }
      const fakeMove = {type:"OUT", qty:1, who:"Proba", reason:"Test"};
      triggerMailtoLowStock({...m}, fakeMove);
    });

    $("#btnExport").addEventListener("click", exportJSON);

    $("#fileImport").addEventListener("change", (e)=>{
      if(e.target.files && e.target.files[0]){
        importJSON(e.target.files[0]);
      }
    });

    /* ========= INICIO ========= */

    (async function init(){
      $("#lblLast").textContent = "–";
      await loadInitial();

      // Se non hai materiais, creamos un par de exemplo
      if(state.materials.length === 0){
        state.materials = [
          {code:"CASCO01", description:"Casco de obra", unit:"uds", stock:5, min_stock:3, location:"Armario A", notes:""},
          {code:"MART01", description:"Martelo", unit:"uds", stock:8, min_stock:2, location:"Estante 2", notes:""}
        ];
        saveLocal();
      }

      render();
    })();
  </script>
</body>
</html>
